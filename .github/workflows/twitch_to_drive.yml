name: Twitch ‚Üí Drive (low-quality, custom time, clean MP4)

on:
  workflow_dispatch:
    inputs:
      start_at:
        description: "B·∫Øt ƒë·∫ßu t·ª´ (HH:MM:SS). V√≠ d·ª• 00:00:00"
        default: "00:00:00"
        required: false
      duration:
        description: 'Th·ªùi l∆∞·ª£ng c·∫ßn t·∫£i (HH:MM:SS). ƒê·∫∑t "0" = l·∫•y h·∫øt'
        default: "01:30:00"
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    permissions:
      contents: write

    env:
      START_AT: ${{ inputs.start_at }}
      DURATION: ${{ inputs.duration }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m pip install --upgrade pip
          pip install --upgrade yt-dlp
          curl -fsSL https://rclone.org/install.sh | sudo bash

      - name: Pick next URL from link.csv (avoid duplicates)
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          touch link.csv linkdalay.csv

          NEXT_URL=""
          while IFS= read -r line || [ -n "${line-}" ]; do
            url="$(printf '%s' "$line" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
            [ -z "$url" ] && continue
            [[ "$url" =~ ^# ]] && continue
            if ! grep -Fqx -- "$url" linkdalay.csv; then
              NEXT_URL="$url"
              break
            fi
          done < link.csv

          if [ -z "$NEXT_URL" ]; then
            echo "selected_url=" >> $GITHUB_OUTPUT
            echo "Kh√¥ng c√≤n link m·ªõi."
            exit 0
          fi

          echo "selected_url=$NEXT_URL" >> $GITHUB_OUTPUT
          echo "Ch·ªçn link: $NEXT_URL"

      - name: Stop if no URL
        if: ${{ steps.pick.outputs.selected_url == '' }}
        run: echo "DONE"

      - name: Configure rclone (Drive OAuth)
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env:
          GDRIVE_OAUTH_TOKEN_JSON: ${{ secrets.GDRIVE_OAUTH_TOKEN_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          TEAM_DRIVE_ID: ${{ secrets.TEAM_DRIVE_ID }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
        run: |
          set -e
          [ -n "$GDRIVE_OAUTH_TOKEN_JSON" ] || { echo "Thi·∫øu GDRIVE_OAUTH_TOKEN_JSON"; exit 1; }
          TOKEN=$(printf "%s" "$GDRIVE_OAUTH_TOKEN_JSON" | tr -d '\n')
          {
            echo "[gdrive]"
            echo "type = drive"
            echo "scope = drive"
            [ -n "$GDRIVE_CLIENT_ID" ] && echo "client_id = $GDRIVE_CLIENT_ID"
            [ -n "$GDRIVE_CLIENT_SECRET" ] && echo "client_secret = $GDRIVE_CLIENT_SECRET"
            echo "token = $TOKEN"
            [ -n "$GDRIVE_FOLDER_ID" ] && echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
            echo "pacer_min_sleep = 2s"
            echo "pacer_burst = 1"
          } > rclone.conf
          [ -n "$TEAM_DRIVE_ID" ] && echo "team_drive = ${TEAM_DRIVE_ID}" >> rclone.conf
          chmod 600 rclone.conf

      - name: Preflight Drive
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env:
          RCLONE_CONFIG: ${{ github.workspace }}/rclone.conf
        run: |
          set -e
          TMP="gdrive:__probe_$RANDOM"
          rclone mkdir "$TMP" --stats 5s --progress
          rclone purge "$TMP" || true

      - name: Twitch ‚Üí ffmpeg ‚Üí MP4 (low, custom time)
        if: ${{ steps.pick.outputs.selected_url != '' }}
        shell: bash
        env:
          URL: ${{ steps.pick.outputs.selected_url }}
          START_AT: ${{ env.START_AT }}
          DURATION: ${{ env.DURATION }}
        run: |
          set -euo pipefail
          mkdir -p out_final

          NAME="$(yt-dlp --print "%(uploader)s_%(title).180B_%(id)s" "$URL" | head -n1)"
          SAFE="$(printf '%s' "$NAME" | tr -d '\n' | sed 's#[/<>:"\\|?*]#_#g')"
          OUT="out_final/${SAFE}.mp4"
          echo "[INFO] Output file: $OUT"

          mapfile -t RAW_URLS < <(yt-dlp -g -f "worst" "$URL")
          if [ "${#RAW_URLS[@]}" -eq 0 ]; then
            echo "Kh√¥ng l·∫•y ƒë∆∞·ª£c URL HLS t·ª´ Twitch"; exit 1
          fi
          SRC="${RAW_URLS[0]}"
          echo "[INFO] Source (worst): $SRC"

          SS_ARGS=()
          T_ARGS=()
          if [[ -n "$START_AT" && "$START_AT" != "0" && "$START_AT" != "00:00:00" ]]; then
            SS_ARGS=(-ss "$START_AT")
          fi
          if [[ -n "$DURATION" && "$DURATION" != "0" ]]; then
            T_ARGS=(-t "$DURATION")
          fi

          ffmpeg -hide_banner -loglevel info -stats \
            "${SS_ARGS[@]}" -i "$SRC" \
            "${T_ARGS[@]}" \
            -vf "scale=-2:480,fps=30" \
            -c:v libx264 -preset veryfast -profile:v high -level 4.1 -pix_fmt yuv420p -crf 24 \
            -c:a aac -b:a 128k -ac 2 -ar 48000 \
            -movflags +faststart \
            -max_muxing_queue_size 1024 \
            "$OUT"

          ls -lh out_final

      - name: Upload to Drive (Anti-429 Optimized)
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env:
          RCLONE_CONFIG: ${{ github.workspace }}/rclone.conf
        shell: bash
        run: |
          set -euo pipefail
          echo "‚è≥ Ch·ªù 5 ph√∫t tr∆∞·ªõc upload ƒë·ªÉ tr√°nh Google rate-limit..."
          sleep 300

          UPLOAD_DIR="out_final"
          MAX_RETRY=10
          RETRY=0
          DELAY=120

          while [ $RETRY -lt $MAX_RETRY ]; do
            echo "üöÄ Upload l·∫ßn $((RETRY+1)) (retry delay hi·ªán t·∫°i: $DELAY gi√¢y)..."

            rclone copy "$UPLOAD_DIR" "gdrive:" \
              --transfers 1 \
              --checkers 1 \
              --bwlimit 8M \
              --tpslimit 0.5 \
              --tpslimit-burst 1 \
              --drive-chunk-size 8M \
              --drive-upload-cutoff 8M \
              --max-backlog 1 \
              --stats 30s \
              --retries 3 \
              --low-level-retries 20 \
              --timeout 1h \
              --contimeout 5m \
              --progress

            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo "üéâ Upload ho√†n t·∫•t th√†nh c√¥ng!"
              rm -rf "$UPLOAD_DIR"
              break
            else
              echo "‚ö†Ô∏è Upload l·ªói (m√£ $EXIT_CODE). Ng·ªß $DELAY gi√¢y r·ªìi th·ª≠ l·∫°i..."
              sleep $DELAY
              RETRY=$((RETRY+1))
              DELAY=$((DELAY * 2))  # tƒÉng delay theo c·∫•p s·ªë nh√¢n
            fi
          done

          if [ $RETRY -eq $MAX_RETRY ]; then
            echo "‚ùå Th·∫•t b·∫°i sau $MAX_RETRY l·∫ßn th·ª≠ upload." >&2
            exit 1
          fi

      - name: Append processed link to linkdalay.csv & push
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env:
          URL: ${{ steps.pick.outputs.selected_url }}
        run: |
          set -e
          grep -Fqx -- "$URL" linkdalay.csv || echo "$URL" >> linkdalay.csv
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add linkdalay.csv
          git commit -m "append processed twitch link: $URL [skip ci]" || echo "No changes."
          git push
