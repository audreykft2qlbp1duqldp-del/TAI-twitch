name: Twitch → Drive (low-quality, custom time, clean MP4, anti-429 segments)

on:
  workflow_dispatch:
    inputs:
      start_at:
        description: "Bắt đầu từ (ví dụ: 00:00:00 / 20m37s / 75s / 0)"
        default: "00:00:00"
        required: false
      duration:
        description: 'Thời lượng cần lấy (ví dụ: 01:30:00 / 20m37s / 0 = toàn bộ)'
        default: "01:30:00"
        required: false
      upload_strategy:
        description: "Cách xuất để upload"
        type: choice
        options: [segments, single]
        default: segments
        required: true
      segment_minutes:
        description: "Độ dài mỗi phân đoạn (phút) khi chọn segments"
        default: "10"
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    permissions:
      contents: write

    env:
      START_AT: ${{ inputs.start_at }}
      DURATION: ${{ inputs.duration }}
      UPLOAD_STRATEGY: ${{ inputs.upload_strategy }}
      SEGMENT_MIN: ${{ inputs.segment_minutes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install tools
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m pip install --upgrade pip
          pip install --upgrade yt-dlp
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Pick next URL from link.csv (avoid duplicates)
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          touch link.csv linkdalay.csv

          NEXT_URL=""
          while IFS= read -r line || [ -n "${line-}" ]; do
            url="$(printf '%s' "$line" | tr -d '\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"
            [ -z "$url" ] && continue
            [[ "$url" =~ ^# ]] && continue
            if ! grep -Fqx -- "$url" linkdalay.csv; then
              NEXT_URL="$url"; break
            fi
          done < link.csv

          if [ -z "$NEXT_URL" ]; then
            echo "selected_url=" >> $GITHUB_OUTPUT
            echo "Không còn link mới."; exit 0
          fi

          echo "selected_url=$NEXT_URL" >> $GITHUB_OUTPUT
          echo "Chọn link: $NEXT_URL"

      - name: Stop if no URL
        if: ${{ steps.pick.outputs.selected_url == '' }}
        run: echo "DONE"

      - name: Configure rclone (Drive OAuth)
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env:
          GDRIVE_OAUTH_TOKEN_JSON: ${{ secrets.GDRIVE_OAUTH_TOKEN_JSON }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          TEAM_DRIVE_ID: ${{ secrets.TEAM_DRIVE_ID }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
        run: |
          set -e
          [ -n "$GDRIVE_OAUTH_TOKEN_JSON" ] || { echo "Thiếu GDRIVE_OAUTH_TOKEN_JSON"; exit 1; }
          TOKEN=$(printf "%s" "$GDRIVE_OAUTH_TOKEN_JSON" | tr -d '\n')
          {
            echo "[gdrive]"
            echo "type = drive"
            echo "scope = drive"
            [ -n "$GDRIVE_CLIENT_ID" ] && echo "client_id = $GDRIVE_CLIENT_ID"
            [ -n "$GDRIVE_CLIENT_SECRET" ] && echo "client_secret = $GDRIVE_CLIENT_SECRET"
            echo "token = $TOKEN"
            [ -n "$GDRIVE_FOLDER_ID" ] && echo "root_folder_id = ${GDRIVE_FOLDER_ID}"
            # nhịp chậm để giảm 429
            echo "pacer_min_sleep = 1s"
            echo "pacer_burst = 1"
          } > rclone.conf
          [ -n "$TEAM_DRIVE_ID" ] && echo "team_drive = ${TEAM_DRIVE_ID}" >> rclone.conf
          chmod 600 rclone.conf

      - name: Preflight Drive
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env: { RCLONE_CONFIG: ${{ github.workspace }}/rclone.conf }
        run: |
          set -e
          TMP="gdrive:__probe_$RANDOM"
          rclone mkdir "$TMP" --stats 5s --progress --disable-http2
          rclone purge "$TMP" || true

      - name: Twitch → ffmpeg (worst) → MP4 clean (single or segments)
        if: ${{ steps.pick.outputs.selected_url != '' }}
        shell: bash
        env:
          URL: ${{ steps.pick.outputs.selected_url }}
          START_AT: ${{ env.START_AT }}
          DURATION: ${{ env.DURATION }}
          UPLOAD_STRATEGY: ${{ env.UPLOAD_STRATEGY }}
          SEGMENT_MIN: ${{ env.SEGMENT_MIN }}
        run: |
          set -euo pipefail
          mkdir -p out_final

          norm_time () {
            s="$(printf '%s' "$1" | tr '[:upper:]' '[:lower:]' | tr -d ' ')"
            [ -z "$s" ] && { echo "0"; return; }
            [ "$s" = "0" ] && { echo "0"; return; }
            if [[ "$s" =~ ^[0-9]+:[0-9]{2}:[0-9]{2}$ ]]; then echo "$s"; return; fi
            local h=0 m=0 sec=0
            if   [[ "$s" =~ ^([0-9]+)h([0-9]+)m([0-9]+)s$ ]]; then h=${BASH_REMATCH[1]}; m=${BASH_REMATCH[2]}; sec=${BASH_REMATCH[3]}
            elif [[ "$s" =~ ^([0-9]+)m([0-9]+)s$ ]]; then m=${BASH_REMATCH[1]}; sec=${BASH_REMATCH[2]}
            elif [[ "$s" =~ ^([0-9]+)h([0-9]+)m$ ]]; then h=${BASH_REMATCH[1]}; m=${BASH_REMATCH[2]}
            elif [[ "$s" =~ ^([0-9]+)h([0-9]+)s$ ]]; then h=${BASH_REMATCH[1]}; sec=${BASH_REMATCH[2]}
            elif [[ "$s" =~ ^([0-9]+)h$ ]]; then h=${BASH_REMATCH[1]}
            elif [[ "$s" =~ ^([0-9]+)m$ ]]; then m=${BASH_REMATCH[1]}
            elif [[ "$s" =~ ^([0-9]+)s$ ]]; then sec=${BASH_REMATCH[1]}
            elif [[ "$s" =~ ^[0-9]+$ ]]; then sec=$s
            else echo "$s"; return; fi
            printf "%02d:%02d:%02d" "$h" "$m" "$sec"
          }

          N_START="$(norm_time "$START_AT")"
          N_DUR="$(norm_time "$DURATION")"

          # Lấy tên file sạch
          NAME="$(yt-dlp --print "%(uploader)s_%(title).180B_%(id)s" "$URL" | head -n1)"
          SAFE="$(printf '%s' "$NAME" | tr -d '\n' | sed 's#[/<>:"\\|?*]#_#g')"

          # Lấy URL thấp nhất (tải nhanh)
          mapfile -t RAW_URLS < <(yt-dlp -g -f "worst" "$URL")
          [ "${#RAW_URLS[@]}" -ge 1 ] || { echo "Không lấy được URL HLS từ Twitch"; exit 1; }
          SRC="${RAW_URLS[0]}"

          SS_ARGS=(); T_ARGS=()
          if [[ "$N_START" != "0" ]]; then SS_ARGS=(-ss "$N_START"); fi
          if [[ "$N_DUR"   != "0" ]]; then T_ARGS=(-t "$N_DUR"); fi

          echo "[INFO] Source (worst): $SRC"
          echo "[INFO] Start: $N_START | Duration: $N_DUR | Strategy: $UPLOAD_STRATEGY"

          if [ "$UPLOAD_STRATEGY" = "segments" ]; then
            # Xuất phân đoạn để upload dễ, chống 429
            SEG_MIN=${SEGMENT_MIN:-10}
            [[ "$SEG_MIN" =~ ^[0-9]+$ ]] || SEG_MIN=10
            SEG_SEC=$((SEG_MIN*60))
            echo "[INFO] Segment mỗi ${SEG_MIN} phút (${SEG_SEC}s)"
            # đặt pattern tên part
            OUTPATTERN="out_final/${SAFE}.part%03d.mp4"
            # encode + segment trực tiếp (moov đầu, keyframe đều)
            ffmpeg -hide_banner -loglevel info -stats \
              "${SS_ARGS[@]}" -i "$SRC" \
              "${T_ARGS[@]}" \
              -vf "scale=-2:480,fps=30" \
              -c:v libx264 -preset veryfast -profile:v high -level 4.1 -pix_fmt yuv420p -crf 24 \
              -c:a aac -b:a 128k -ac 2 -ar 48000 \
              -movflags +faststart \
              -force_key_frames "expr:gte(t,n_forced*2)" \
              -max_muxing_queue_size 1024 \
              -f segment \
              -segment_time ${SEG_SEC} \
              -reset_timestamps 1 \
              "$OUTPATTERN"
          else
            # single file
            OUT="out_final/${SAFE}.mp4"
            ffmpeg -hide_banner -loglevel info -stats \
              "${SS_ARGS[@]}" -i "$SRC" \
              "${T_ARGS[@]}" \
              -vf "scale=-2:480,fps=30" \
              -c:v libx264 -preset veryfast -profile:v high -level 4.1 -pix_fmt yuv420p -crf 24 \
              -c:a aac -b:a 128k -ac 2 -ar 48000 \
              -movflags +faststart \
              -max_muxing_queue_size 1024 \
              "$OUT"
          fi

          ls -lh out_final

      - name: Upload to Drive (robust, progress, anti-429)
        if: ${{ steps.pick.outputs.selected_url != '' }}
        shell: bash
        env:
          RCLONE_CONFIG: ${{ github.workspace }}/rclone.conf
          UPLOAD_STRATEGY: ${{ env.UPLOAD_STRATEGY }}
        run: |
          set -euo pipefail
          # Cờ upload "lịch sự"
          RFLAGS="--transfers 1 --checkers 1 --tpslimit 0.5 --tpslimit-burst 1 --drive-chunk-size 16M --stats 10s --progress --retries 1 --low-level-retries 10 --disable-http2"

          if [ "$UPLOAD_STRATEGY" = "segments" ]; then
            echo "[UPLOAD] Chế độ segments"
            shopt -s nullglob
            for f in out_final/*.mp4; do
              base="$(basename "$f")"
              echo "→ Upload: $base"
              # retry tăng dần cho từng part
              for i in 1 2 3 4 5 6 7 8; do
                rclone copyto "$f" "gdrive:$base" $RFLAGS && break
                SLEEP=$((i*45))
                echo "[WARN] lỗi (có thể 429), chờ ${SLEEP}s rồi thử lại part này..."
                sleep "$SLEEP"
                if [ "$i" -eq 8 ]; then
                  echo "[FATAL] Part $base upload mãi không được."; exit 1
                fi
              done
              rm -f "$f"
            done
            rmdir out_final || true
          else
            echo "[UPLOAD] Chế độ single"
            f=(out_final/*.mp4)
            [ -f "${f[0]-}" ] || { echo "Không thấy file để upload"; exit 1; }
            src="${f[0]}"
            tmpremote="gdrive:$(basename "$src").uploading"
            finalremote="gdrive:$(basename "$src")"

            # Up vào tên .uploading để tránh trùng/danh sách phình to khi retry
            for i in 1 2 3 4 5 6 7 8; do
              rclone copyto "$src" "$tmpremote" $RFLAGS && break
              SLEEP=$((i*60))
              echo "[WARN] lỗi (có thể 429), chờ ${SLEEP}s rồi thử lại..."
              sleep "$SLEEP"
              if [ "$i" -eq 8 ]; then
                echo "[FATAL] Upload single file mãi không được."; exit 1
              fi
            done

            # Đổi tên về file thật sau khi up xong
            rclone moveto "$tmpremote" "$finalremote" --stats 5s --progress --disable-http2 || true
            rm -rf out_final
          fi

      - name: Append processed link to linkdalay.csv & push
        if: ${{ steps.pick.outputs.selected_url != '' }}
        env: { URL: ${{ steps.pick.outputs.selected_url }} }
        run: |
          set -e
          grep -Fqx -- "$URL" linkdalay.csv || echo "$URL" >> linkdalay.csv
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add linkdalay.csv
          git commit -m "append processed twitch link: $URL [skip ci]" || echo "No changes."
          git push
